<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Toko</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f4f4f4;
            flex-direction: column;
            overflow: auto;
        }
        .container {
            background: white;
            padding: 20px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            text-align: center;
            
            display: none; /* Awalnya semua disembunyikan */
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #28a745;
            color: white;
        }
        input {
            display: block;
            width: 90%;
            margin: 5px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            border-radius: 5px;
        }
        button:hover {
            background-color: #218838;
        }
        #barangContainer {
            max-height: 300px; /* Atur tinggi maksimum daftar barang */
            overflow-y: auto; /* Aktifkan scroll vertikal */
            border: 1px solid #ddd; /* Tambahkan border agar lebih jelas */
            position: relative; /* Pastikan elemen dalamnya bisa diatur posisinya */
        }

        #barangContainer table {
            width: 100%;
            border-collapse: collapse;
        }
        #barangContainer thead {
            position: sticky;
            top: 0;
            background-color: #28a745; /* Warna latar belakang agar sesuai dengan desain */
            color: white;
            z-index: 10; /* Pastikan tetap di atas saat di-scroll */
        }

        /* Gaya dasar alert */
        .alert {
            position: fixed;
            top: 20px;
            right: -300px; /* Awalnya tersembunyi */
            background-color: #28a745;
            color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: right 0.5s ease-in-out, opacity 0.5s ease-in-out;
            opacity: 0;
        }

        /* Tampilkan alert */
        .alert.show {
            right: 20px;
            opacity: 1;
        }

        /* Variasi warna untuk status */
        .alert.error {
            background-color: #dc3545;
        }

        .alert.warning {
            background-color: #ffc107;
        }

        .price-diff {
            position: fixed;
            right: 20px;
            top: 100px;
            width: 250px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            display: none;
        }
    </style>
</head>
<body>
    <!-- Halaman Login -->
    <div id="custom-alert" class="alert"></div>
    <div id="login-container" class="container">
        <h2>Login Admin <br> Toko H Endun</h2>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button id="login-btn">Login</button>
        <button id="google-login-btn">Login dengan Google</button>
        <input type="email" id="signup-email" placeholder="Email Baru">
        <input type="password" id="signup-password" placeholder="Password Baru">
        <button id="signup-btn">Daftar</button>
        <p><i>created by pasya</i></p>
    </div>

    <!-- Halaman Dashboard -->
    <div id="dashboard-container" class="container">
        <h2>Dashboard</h2>
        <p>Selamat datang, <span id="user-email"></span>!</p>
        <button id="logout-btn">Logout</button>
        
        <input type="text" id="namaBarang" placeholder="Nama Barang">
        <input type="number" id="hargaBarang" placeholder="Harga (Rp)">
        <button id="btnTambah">Tambah Barang</button>

        <input type="text" id="searchBarang" placeholder="Cari Barang" oninput="loadBarang()">
        <div id="barangContainer">
            <div style="overflow-y: auto; max-height: 300px;">
            <table>
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Nama Barang</th>
                        <th>Harga</th>
                        <th>Terakhir Diedit</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="barangList"></tbody>
            </table>
        </div>
    </div>

    <!-- Tambahkan elemen untuk iklan selisih harga -->
    <div id="price-diff-container" class="price-diff">
        <h3>Perubahan Harga</h3>
        <p><strong>Nama Barang:</strong> <span id="diff-nama"></span></p>
        <p><strong>Harga Lama:</strong> Rp <span id="harga-lama">-</span></p>
        <p><strong>Harga Baru:</strong> Rp <span id="harga-baru">-</span></p>
        <p><strong>Selisih:</strong> Rp <span id="selisih-harga">-</span></p>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";
        import { GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";
        import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";


        function showAlert(message, type = "success") {
            const alertBox = document.getElementById("custom-alert");
            alertBox.innerText = message;
            
            // Tambah kelas warna berdasarkan tipe alert
            alertBox.className = `alert ${type} show`;
            
            // Sembunyikan alert setelah 3 detik
            setTimeout(() => {
                alertBox.classList.remove("show");
            }, 3000);
        }


        // Fungsi Sign-Up (Pendaftaran Akun Baru)
        document.getElementById("signup-btn").addEventListener("click", async () => {
            const email = document.getElementById("signup-email").value;
            const password = document.getElementById("signup-password").value;

            if (!email || !password) {
                showAlert("Email dan password harus diisi!");
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                showAlert("Pendaftaran berhasil! Selamat datang:","berhasil" );
            } catch (error) {
                showAlert("Pendaftaran gagal:" + $error.message, "gagal");
            }
        });

        const provider = new GoogleAuthProvider();
        // Fungsi Login dengan Google
        document.getElementById("google-login-btn").addEventListener("click", () => {
            signInWithPopup(auth, provider)
                .then(() => {
                    showAlert("Login berhasil!", "success");
                })
                .catch((error) => {
                    showAlert("Login gagal: ", "error");
                });
        });
        const firebaseConfig = {
            apiKey: "AIzaSyCEng2Zpss0ATs3wkGs_vgy1YViSzkf07E",
            authDomain: "toko-eaa04.firebaseapp.com",
            projectId: "toko-eaa04",
            storageBucket: "toko-eaa04.appspot.com",
            messagingSenderId: "761393852069",
            appId: "1:761393852069:web:c9250f50038028d255e74c"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let editId = null;
      
        // Mengatur tampilan halaman berdasarkan status login
        function toggleView(user) {
            if (user) {
                document.getElementById("login-container").style.display = "none";
                document.getElementById("dashboard-container").style.display = "block";
                document.getElementById("user-email").innerText = user.email;
                loadBarang();
            } else {
                document.getElementById("login-container").style.display = "block";
                document.getElementById("dashboard-container").style.display = "none";
            }
        }

        onAuthStateChanged(auth, (user) => {
            toggleView(user);
        });

        document.getElementById("login-btn").addEventListener("click", () => {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;

            signInWithEmailAndPassword(auth, email, password)
                .then(() => {
                    showAlert("Login berhasil!", "succsess");
                })
                .catch(error => {
                    showAlert("Login gagal: " + error.message, "error");
                });
        });

        document.getElementById("logout-btn").addEventListener("click", () => {
            signOut(auth);
        });

        async function loadBarang() {
            let querySnapshot = await getDocs(collection(db, "barang"));
            let table = document.getElementById("barangList");
            let searchInput = document.getElementById("searchBarang");

            if (!searchInput) {
                console.error("Elemen input pencarian tidak ditemukan!");
                return;
            }

            let searchValue = searchInput.value.trim().toLowerCase();
            console.log("Nilai pencarian:", searchValue);

            table.innerHTML = "";

            let dataList = [];
            
            querySnapshot.forEach((docSnapshot) => {
                let data = docSnapshot.data();
                dataList.push({
                    id: docSnapshot.id,
                    nama: data.nama,
                    harga: data.harga,
                    editedAt: data.editedAt ? new Date(data.editedAt.toDate()).toLocaleDateString("id-ID") : "-"
                });
            });

            let filteredData = dataList.filter(item => 
                item.nama && item.nama.toLowerCase().includes(searchValue)
            );

            if (filteredData.length === 0) {
                table.innerHTML = "<tr><td colspan='5'>Barang tidak ditemukan</td></tr>";
            } else {
                filteredData.forEach((item, index) => {
                    let row = table.insertRow();
                    row.innerHTML = `<td>${index + 1}</td> 
                                    <td>${item.nama}</td>
                                    <td>Rp ${item.harga}</td>
                                    <td>${item.editedAt}</td> <!-- Menampilkan tanggal terakhir edit -->
                                    <td>
                                        <button onclick="editBarang('${item.id}', '${item.nama}', '${item.harga}')">Edit</button>
                                        <button onclick="hapusBarang('${item.id}')">Hapus</button>
                                    </td>`;
                });
            }
        }


        window.loadBarang = loadBarang;

        function updatePriceDiff(nama, hargaLama, hargaBaru) {
            document.getElementById("diff-nama").textContent = nama;
            document.getElementById("harga-lama").textContent = hargaLama;
            document.getElementById("harga-baru").textContent = hargaBaru;
            document.getElementById("selisih-harga").textContent = hargaBaru - hargaLama;
            document.getElementById("price-diff-container").style.display = "block";
        }

        window.editBarang = function(id, nama, harga) {
            document.getElementById("namaBarang").value = nama;
            document.getElementById("hargaBarang").value = harga;
            editId = id;
            document.getElementById("btnTambah").textContent = "Simpan Perubahan";
            document.getElementById("btnTambah").onclick = async function() {
                let newNama = document.getElementById("namaBarang").value;
                let newHarga = document.getElementById("hargaBarang").value;
                if (!newNama || !newHarga) {
                    showAlert("Nama dan harga barang harus diisi!", "error");
                    return;
                }
                updatePriceDiff(nama, harga, newHarga);
                
                if (editId) {
                    await updateDoc(doc(db, "barang", editId), {
                        nama: newNama,
                        harga: newHarga,
                        editedAt: new Date()
                    });
                    showAlert("Barang berhasil diperbarui!", "success");
                    editId = null;
                    document.getElementById("btnTambah").textContent = "Tambah Barang";
                }
                loadBarang();
            };
        };

        window.hapusBarang = async function(id) {
            if (confirm("Apakah Anda yakin ingin menghapus barang ini?")) {
                await deleteDoc(doc(db, "barang", id));
                showAlert("Barang berhasil dihapus!");
                loadBarang();
            }
        };

        document.getElementById("btnTambah").addEventListener("click", async () => {
            let nama = document.getElementById("namaBarang").value;
            let harga = document.getElementById("hargaBarang").value;
            
            if (!nama || !harga) {
                showAlert("Nama dan harga barang harus diisi!");
                return;
            }
            
            if (editId) {
                await updateDoc(doc(db, "barang", editId), { nama, harga });
                showAlert("Barang berhasil diperbarui!");
                editId = null;
                document.getElementById("btnTambah").textContent = "Tambah Barang";
            } else {
                await addDoc(collection(db, "barang"), { nama, harga });
                showAlert("Barang berhasil ditambahkan!");
            }
            
            document.getElementById("namaBarang").value = "";
            document.getElementById("hargaBarang").value = "";
            loadBarang();
        });
    </script>
</body>
</html>
